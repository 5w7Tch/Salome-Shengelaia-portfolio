<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="salome.png" />

  <title>Salome Shengelaia Portfolio</title>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loader-container">
      <div class="loader"></div>
      <p class="loading-text">Loading Portfolio...</p>
      <p class="loading-progress" id="loadingProgress">0%</p>
    </div>
  </div>

  <!-- Background loading indicator -->
  <div class="bg-loading-indicator" id="bgLoadingIndicator" style="display: none;">
    <div class="bg-loader"></div>
    <span id="bgLoadingText">Loading pages...</span>
  </div>

  <button class="nav-arrow prev-arrow" id="prevBtn">‹</button>
  <button class="nav-arrow next-arrow" id="nextBtn">›</button>

  <!-- Download Button -->
  <button class="download-btn" id="downloadBtn" title="Download Portfolio PDF">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="7 10 12 15 17 10"></polyline>
      <line x1="12" y1="15" x2="12" y2="3"></line>
    </svg>
    <div class="download-progress" id="downloadProgress"></div>
  </button>

  <!-- Pagination Dots -->
  <div class="pagination-dots" id="paginationDots"></div>

  <div class="flipbook">
    <!-- Dynamic pages will be inserted here -->
    <div class="hard"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="jquery.js"></script>
  <script src="turn.js"></script>
  <script>
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Path to your PDF file
    const pdfPath = 'PORTFOLIOOO.pdf';
    let loadedPages = new Set();
    let totalPagesCount = 0;
    let flipbookInitialized = false;
    let isAnimating = false; // Animation lock flag

    // Update loading progress
    function updateProgress(current, total) {
      const percentage = Math.round((current / total) * 100);
      $('#loadingProgress').text(percentage + '%');
    }

    // Hide initial loading screen
    function hideLoadingScreen() {
      $('#loadingScreen').fadeOut(500, function() {
        $(this).remove();
      });
    }

    // Update background loading indicator
    function updateBackgroundLoading(current, total) {
      $('#bgLoadingIndicator').fadeOut();

      // if (current >= total) {
      //   $('#bgLoadingIndicator').fadeOut();
      // } else {
      //   $('#bgLoadingText').text(`Loading pages... ${current}/${total}`);
      // }
    }

    // Create placeholder page
    function createPlaceholderPage() {
      const pageDiv = $('<div class="page page-loading"></div>');
      pageDiv.html('<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><div><div class="loader" style="margin: 0 auto 20px;"></div><p>Loading page...</p></div></div>');
      return pageDiv;
    }

    // Render a single page
    async function renderPage(pdf, pageNum, pageDiv) {
      try {
        const page = await pdf.getPage(pageNum);
        
        // Create canvas for this page
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        // Get the viewport at scale 1
        const viewport = page.getViewport({ scale: 1 });
        
        // Calculate device pixel ratio for retina displays
        const pixelRatio = window.devicePixelRatio || 1;
        
        // Calculate scale to fit the page (594px width for half of 1188px)
        const displayScale = Math.min(594 / viewport.width, 840 / viewport.height);
        const renderScale = displayScale * 2.5 * pixelRatio; // Render at 2.5x for high quality
        
        const scaledViewport = page.getViewport({ scale: renderScale });
        
        // Set canvas size to the scaled viewport
        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;
        
        // Set display size to fill the entire page (no CSS resizing)
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.display = 'block';
        
        // Scale the context to match device pixel ratio
        context.scale(pixelRatio, pixelRatio);
        
        // Render PDF page to canvas with high quality settings
        await page.render({
          canvasContext: context,
          viewport: page.getViewport({ scale: renderScale / pixelRatio }),
          intent: 'display',
          renderInteractiveForms: false,
          enableWebGL: true
        }).promise;
        
        // Replace placeholder content with canvas
        pageDiv.empty();
        pageDiv.removeClass('page-loading');
        pageDiv.append(canvas);
        
        // Mark page as loaded
        loadedPages.add(pageNum);
        
        // Update background loading indicator
        updateBackgroundLoading(loadedPages.size, totalPagesCount);
        
        return true;
      } catch (error) {
        console.error(`Error rendering page ${pageNum}:`, error);
        pageDiv.html('<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ff4444;"><p>Error loading page</p></div>');
        return false;
      }
    }

    // Download PDF with progress
    async function downloadPDF() {
      const downloadBtn = $('#downloadBtn');
      const progressBar = $('#downloadProgress');
      
      // Disable button during download
      downloadBtn.addClass('downloading');
      downloadBtn.prop('disabled', true);
      
      try {
        const response = await fetch(pdfPath);
        
        if (!response.ok) {
          throw new Error('Download failed');
        }
        
        const contentLength = response.headers.get('content-length');
        const total = parseInt(contentLength, 10);
        
        let loaded = 0;
        const reader = response.body.getReader();
        const chunks = [];
        
        while (true) {
          const { done, value } = await reader.read();
          
          if (done) break;
          
          chunks.push(value);
          loaded += value.length;
          
          // Update progress bar
          if (total) {
            const percentage = (loaded / total) * 100;
            progressBar.css('width', percentage + '%');
          }
        }
        
        // Create blob and download
        const blob = new Blob(chunks, { type: 'application/pdf' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Salome_Shengelaia_Portfolio.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Success animation
        setTimeout(() => {
          progressBar.css('width', '0%');
          downloadBtn.removeClass('downloading');
          downloadBtn.prop('disabled', false);
        }, 1000);
        
      } catch (error) {
        console.error('Download error:', error);
        alert('Failed to download PDF. Please try again.');
        progressBar.css('width', '0%');
        downloadBtn.removeClass('downloading');
        downloadBtn.prop('disabled', false);
      }
    }

    // Load and render PDF
    async function loadPDF() {
      try {
        const loadingTask = pdfjsLib.getDocument(pdfPath);
        
        loadingTask.onProgress = function(progress) {
          if (progress.total > 0) {
            const percentage = Math.round((progress.loaded / progress.total) * 100);
            $('#loadingProgress').text(percentage + '%');
          }
        };
        
        const pdf = await loadingTask.promise;
        totalPagesCount = pdf.numPages;
        window.pdfDocument = pdf; // Store globally
        
        const flipbook = $('.flipbook');
        const lastHard = flipbook.find('.hard');
        
        // Create placeholders
        for (let pageNum = 1; pageNum <= totalPagesCount; pageNum++) {
          const pageDiv = createPlaceholderPage();
          pageDiv.attr('data-page-num', pageNum);
          pageDiv.insertBefore(lastHard);
        }
        
        initializeFlipbook();
        hideLoadingScreen();
        
        // Only render first 6 pages
        console.log('Rendering initial pages...');
        for (let pageNum = 1; pageNum <= Math.min(6, totalPagesCount); pageNum++) {
          const pageDiv = flipbook.find(`.page[data-page-num="${pageNum}"]`);
          await renderPage(pdf, pageNum, pageDiv);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('Initial pages loaded. Pages will load on demand.');
        
        // Load pages on demand when turning
        $(".flipbook").bind("turning", async function(event, page, view) {
          const pagesToLoad = new Set();
          
          // Current view
          view.forEach(p => p && !loadedPages.has(p) && pagesToLoad.add(p));
          
          // Preload next pages
          for (let i = 1; i <= 4; i++) {
            const nextPage = page + i;
            if (nextPage <= totalPagesCount && !loadedPages.has(nextPage)) {
              pagesToLoad.add(nextPage);
            }
          }
          
          for (let pageNum of pagesToLoad) {
            const pageDiv = flipbook.find(`.page[data-page-num="${pageNum}"]`);
            if (pageDiv.hasClass('page-loading')) {
              renderPage(pdf, pageNum, pageDiv);
              await new Promise(resolve => setTimeout(resolve, 50));
            }
          }
        });
        
      } catch (error) {
        console.error('Error loading PDF:', error);
        $('#loadingText').text('Error loading portfolio');
        $('#loadingProgress').text('Please refresh the page');
      }
    }

    function initializeFlipbook() {
      // Original dimensions for double-page spread
      const originalWidth = 1188;
      const originalHeight = 840;
      const aspectRatio = originalWidth / originalHeight;
      
      // Get available space
      const isMobile = window.innerWidth <= 768;
      const availableWidth = window.innerWidth - (isMobile ? 0 : 80); // Less margin on mobile
      const availableHeight = window.innerHeight - (isMobile ? 80 : 100);
      
      let flipbookWidth, flipbookHeight;
      
      // Calculate dimensions maintaining aspect ratio
      if (availableWidth / availableHeight > aspectRatio) {
        // Height is limiting
        flipbookHeight = availableHeight;
        flipbookWidth = flipbookHeight * aspectRatio;
      } else {
        // Width is limiting
        flipbookWidth = availableWidth;
        flipbookHeight = flipbookWidth / aspectRatio;
      }
      
      // Don't exceed original size on large screens
      flipbookWidth = Math.min(flipbookWidth, originalWidth);
      flipbookHeight = Math.min(flipbookHeight, originalHeight);
      
      console.log('Initializing flipbook:', { 
        width: flipbookWidth, 
        height: flipbookHeight,
        isMobile: isMobile,
        availableWidth: availableWidth,
        availableHeight: availableHeight
      });
      
      $(".flipbook").turn({
        width: flipbookWidth,
        height: flipbookHeight,
        autoCenter: true,
        acceleration: true,
        gradients: true,
        display: 'double', // Always double-page
        duration: 600
      });

      flipbookInitialized = true;

      // Generate pagination dots
      const totalPages = $(".flipbook").turn("pages");
      generatePaginationDots(totalPages);
      updatePaginationDots(1);

      // Listen for animation start and end
      $(".flipbook").bind("start", function() {
        isAnimating = true;
      });

      $(".flipbook").bind("end", function() {
        isAnimating = false;
      });

      // Keyboard navigation with animation lock
      $(document).keydown(function(e) {
        // Prevent action if already animating
        if (isAnimating) {
          e.preventDefault();
          return;
        }

        // Left arrow key
        if (e.keyCode == 37) {
          $('#prevBtn').click();
          e.preventDefault();
        }
        
        // Right arrow key
        if (e.keyCode == 39) {
          $('#nextBtn').click();
          e.preventDefault();
        }
      });

      // Navigation buttons with corner peel animation and lock
      $('#prevBtn').click(function() {
        // Prevent click if already animating
        if (isAnimating) return;

        var page = $(".flipbook").turn("page");
        if (page > 1) {
          isAnimating = true; // Lock immediately
          $(".flipbook").turn("peel", "bl", true);
          setTimeout(function() {
            $(".flipbook").turn("previous");
          }, 40);
        }
      });

      $('#nextBtn').click(function() {
        // Prevent click if already animating
        if (isAnimating) return;

        var page = $(".flipbook").turn("page");
        var pages = $(".flipbook").turn("pages");
        if (page < pages) {
          isAnimating = true; // Lock immediately
          $(".flipbook").turn("peel", "br", true);
          setTimeout(function() {
            $(".flipbook").turn("next");
          }, 40);
        }
      });

      // Hide/show arrows based on current page and update pagination
      $(".flipbook").bind("turned", function(event, page, view) {
        if (page == 1) {
          $('#prevBtn').fadeOut();
        } else {
          $('#prevBtn').fadeIn();
        }

        if (page == $(".flipbook").turn("pages")) {
          $('#nextBtn').fadeOut();
        } else {
          $('#nextBtn').fadeIn();
        }

        // Update pagination dots after turn completes
        updatePaginationDots(page);
      });

      // Initial state
      $('#prevBtn').hide();
      
      // Handle orientation changes
      let resizeTimeout;
      $(window).on('resize orientationchange', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          location.reload();
        }, 500);
      });
    }

    // Generate pagination dots
    function generatePaginationDots(totalPages) {
      const paginationContainer = $('#paginationDots');
      paginationContainer.empty();
      
      for (let i = 1; i <= totalPages; i++) {
        const dot = $('<div class="pagination-dot"></div>');
        dot.attr('data-page', i);
        paginationContainer.append(dot);
      }
    }

    // Update pagination dots based on current page
    function updatePaginationDots(currentPage) {
      const dots = $('.pagination-dot');
      const totalPages = dots.length;
      const maxVisibleDots = 7;
      
      dots.each(function(index) {
        const pageNum = index + 1;
        const distance = Math.abs(pageNum - currentPage);
        const dot = $(this);
        
        // Remove all classes
        dot.removeClass('active near far hidden');
        
        // Only show dots within distance of 3 from current page
        if (distance > 3) {
          dot.addClass('hidden');
          return;
        }
        
        // Apply size classes based on distance from current page
        if (distance === 0) {
          dot.addClass('active');
        } else if (distance === 1) {
          dot.addClass('near');
        } else if (distance === 2) {
          dot.addClass('far');
        } else if (distance === 3) {
          dot.addClass('far');
        }
      });
    }

    // Load PDF when page is ready
    $(document).ready(function() {
      loadPDF();
      
      // Download button click handler
      $('#downloadBtn').click(function() {
        if (!$(this).hasClass('downloading')) {
          downloadPDF();
        }
      });
    });
  </script>

  <style>
    /* Background loading indicator styles */
    .bg-loading-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .bg-loader {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Page loading state */
    .page-loading {
      background: #f5f5f5;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Disable pointer events on buttons during animation */
    .nav-arrow.animating {
      pointer-events: none;
      opacity: 0.5;
    }
  </style>
</body>

</html>